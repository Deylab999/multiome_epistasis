# This script identifies highly variable genes for epistasis testing using the
# FindVariableFeatures functionality (mvp method) implemented in Seurat. This
# method first computes the mean and dispersion using the raw counts for each
# gene. Then, by binning the genes into 20 bins, this method identifies
# outliers for dispersion based on z-score, and uses those as highly variable
# genes for downstream single-cell analysis.
#
# Author: Karthik Guruvayurappan

library(Seurat)

# read in scRNA-seq matrix into Seurat
rna <- readRDS(snakemake@input[[1]])
rna <- CreateSeuratObject(counts = rna)

# compute highly variable features using mean-var plot method
rna <- NormalizeData(rna)
rna <- FindVariableFeatures(rna, selection.method = 'mean.var.plot')

# save highly variable genes to an output CSV file
var.genes <- rna@assays$RNA@var.features
write.csv(
    var.genes,
    snakemake@output[[1]],
    row.names = FALSE,
    quote = FALSE
)
